<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BK Market Analyzer</title>
    <style>
        body {
            margin: 0;
            font-family: monospace;
            background-color: #0d1b2a;
            color: #00ff99;
        }
        .center-screen {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            flex-direction: column;
            text-align: center;
        }
        .btn {
            background: #003049;
            color: #00ff99;
            border: 2px solid #00ff99;
            padding: 12px 24px;
            cursor: pointer;
            font-size: 1rem;
            margin: 10px;
        }
        .btn:hover {
            background: #00ff99;
            color: #003049;
        }
        .hidden {
            display: none;
        }
        #log {
            white-space: pre-wrap;
            background: #001219;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
            border: 1px solid #00ff99;
        }
    </style>
</head>
<body>
<div id="welcome" class="center-screen">
    <h1 id="welcomeText"></h1>
    <button id="connectBtn" class="btn">Connect to Deriv</button>
</div>

<div id="tool" class="hidden">
    <div style="padding: 20px;">
        <h2>Market Analysis Tool</h2>
        <button id="autoRunBtn" class="btn">Auto-Run All Markets</button>
        <select id="marketSelect" class="btn"></select>
        <button id="specifyBtn" class="btn">Analyze Selected Market</button>
        <div id="log"></div>
    </div>
</div>

<script>
const APP_ID = 95137;
const TRUSTED_PARENT = 'https://brian61957.github.io';
const connectBtn = document.getElementById('connectBtn');
const welcomeText = document.getElementById('welcomeText');
const welcomeDiv = document.getElementById('welcome');
const toolDiv = document.getElementById('tool');
const logDiv = document.getElementById('log');
const marketSelect = document.getElementById('marketSelect');
const autoRunBtn = document.getElementById('autoRunBtn');
const specifyBtn = document.getElementById('specifyBtn');

// Typing effect
const message = "Welcome to BK Market Analyzer...";
let idx = 0;
function typeText() {
    if (idx < message.length) {
        welcomeText.textContent += message.charAt(idx);
        idx++;
        setTimeout(typeText, 50);
    }
}
typeText();

// OAuth connect
connectBtn.addEventListener('click', () => {
    const redirectUri = `${window.location.origin}${window.location.pathname.replace(/index\.html$/, '')}redirect.html`;
    const loginUrl = `https://oauth.deriv.com/oauth2/authorize?app_id=${APP_ID}&redirect_uri=${encodeURIComponent(redirectUri)}`;
    window.location.href = loginUrl;
});

// Load tool if token exists
const token = sessionStorage.getItem('deriv_access_token');
if (token) {
    welcomeDiv.classList.add('hidden');
    toolDiv.classList.remove('hidden');
    initTool(token);
}

function initTool(token) {
    const ws = new WebSocket('wss://ws.derivws.com/websockets/v3?app_id=' + APP_ID);

    ws.onopen = () => {
        ws.send(JSON.stringify({ authorize: token }));
    };

    ws.onmessage = (msg) => {
        const data = JSON.parse(msg.data);
        if (data.msg_type === 'authorize') {
            log("Authorized as " + data.authorize.loginid);
            fetchMarkets(ws);
        }
        if (data.msg_type === 'active_symbols') {
            populateMarkets(data.active_symbols);
        }
        if (data.msg_type === 'tick') {
            log(`Tick: ${data.tick.symbol} - ${data.tick.quote}`);
        }
    };

    autoRunBtn.onclick = () => {
        log("Auto-running analysis for all markets...");
        fetchMarkets(ws, true);
    };

    specifyBtn.onclick = () => {
        const symbol = marketSelect.value;
        log("Analyzing: " + symbol);
        ws.send(JSON.stringify({ ticks: symbol }));
    };
}

function fetchMarkets(ws, autoRun = false) {
    ws.send(JSON.stringify({ active_symbols: 'brief', product_type: 'basic' }));
    if (autoRun) {
        setTimeout(() => {
            const opts = marketSelect.options;
            for (let i = 0; i < opts.length; i++) {
                ws.send(JSON.stringify({ ticks: opts[i].value }));
            }
        }, 2000);
    }
}

function populateMarkets(symbols) {
    marketSelect.innerHTML = '';
    symbols.forEach(sym => {
        const opt = document.createElement('option');
        opt.value = sym.symbol;
        opt.textContent = `${sym.display_name} (${sym.symbol})`;
        marketSelect.appendChild(opt);
    });
}

function log(message) {
    logDiv.textContent += message + '\n';
    logDiv.scrollTop = logDiv.scrollHeight;
}
</script>
</body>
</html>
